<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Foodie World</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
    <style>
        /* Define a subtle dark mode transition for all elements */
        body {
            transition: background-color 0.3s ease, color 0.3s ease;
            font-family: 'Inter', sans-serif;
        }

        /* Custom styles for the animated message box */
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            padding: 1rem 2rem;
            border-radius: 9999px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            font-weight: 600;
            transition: all 0.3s ease-in-out;
            opacity: 0;
            visibility: hidden;
            white-space: nowrap;
        }

        .message-box.show {
            opacity: 1;
            visibility: visible;
        }

        /* Custom style for the fancy main title */
        .fancy-title {
            font-family: 'Pacifico', cursive;
            background-image: linear-gradient(to right, #F97316, #EF4444);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 2.5rem;
            text-align: center;
        }

        /* Custom style for post cards with a subtle hover effect */
        .post-card {
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            border-radius: 1.5rem;
            overflow: hidden;
        }

        .post-card:hover {
            transform: scale(1.02);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
        }

        /* Custom style for button hover effect */
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }

        /* Custom styles for the progress bar */
        .progress-bar {
            height: 8px;
            background-color: #e5e7eb;
            border-radius: 9999px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background-color: #3b82f6;
            transition: width 0.3s ease;
        }
    </style>
</head>

<body class="bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200">

    <div id="message-box" class="message-box bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200"></div>

    <div id="confirm-modal"
        class="fixed inset-0 z-[1001] bg-gray-900 bg-opacity-50 hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
            <p id="confirm-message" class="text-lg font-semibold mb-6">Are you sure you want to delete this post?</p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-yes"
                    class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 transition duration-300">
                    Yes, Delete
                </button>
                <button id="confirm-no"
                    class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400 transition duration-300">
                    Cancel
                </button>
            </div>
        </div>
    </div>


    <div class="container mx-auto max-w-2xl px-4 py-8">
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold fancy-title">Foodie World</h1>
            <div id="auth-info" class="text-sm font-semibold flex items-center space-x-2">
                </div>
        </header>

        <div id="auth-section" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md mb-8 hidden">
            <div id="login-form-container">
                <h2 class="text-2xl font-semibold mb-4 text-center">Log In to Your Account</h2>
                <form id="login-form" class="space-y-4">
                    <input type="email" id="login-email" placeholder="Email"
                        class="w-full p-3 rounded-lg border dark:border-gray-700 dark:bg-gray-900 focus:outline-none focus:ring-2 focus:ring-orange-500"
                        required>
                    <input type="password" id="login-password" placeholder="Password"
                        class="w-full p-3 rounded-lg border dark:border-gray-700 dark:bg-gray-900 focus:outline-none focus:ring-2 focus:ring-orange-500"
                        required>
                    <button type="submit"
                        class="w-full bg-orange-500 text-white font-bold py-3 rounded-lg hover:bg-orange-600 transition duration-300">
                        Log In
                    </button>
                </form>
                <p class="mt-4 text-center text-sm">
                    Don't have an account? <a href="#" id="show-signup" class="text-orange-500 hover:underline">Sign up
                        here</a>.
                </p>
            </div>

            <div id="signup-form-container" class="hidden">
                <h2 class="text-2xl font-semibold mb-4 text-center">Create a New Account</h2>
                <form id="signup-form" class="space-y-4">
                    <input type="email" id="signup-email" placeholder="Email"
                        class="w-full p-3 rounded-lg border dark:border-gray-700 dark:bg-gray-900 focus:outline-none focus:ring-2 focus:ring-orange-500"
                        required>
                    <input type="password" id="signup-password" placeholder="Password (min 6 characters)"
                        class="w-full p-3 rounded-lg border dark:border-gray-700 dark:bg-gray-900 focus:outline-none focus:ring-2 focus:ring-orange-500"
                        required>
                    <button type="submit"
                        class="w-full bg-orange-500 text-white font-bold py-3 rounded-lg hover:bg-orange-600 transition duration-300">
                        Sign Up
                    </button>
                </form>
                <p class="mt-4 text-center text-sm">
                    Already have an account? <a href="#" id="show-login" class="text-orange-500 hover:underline">Log in
                        here</a>.
                </p>
            </div>
        </div>

        <div id="app-content" class="hidden">
            <div id="new-post-section" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md mb-8">
                <h2 class="text-xl font-semibold mb-4">Create a new post</h2>
                <form id="new-post-form" class="space-y-4">
                    <textarea id="post-content"
                        class="w-full p-3 rounded-lg border dark:border-gray-700 dark:bg-gray-900 focus:outline-none focus:ring-2 focus:ring-orange-500"
                        placeholder="What's cooking?" rows="3" required></textarea>
                    <div>
                        <input type="file" id="media-input" accept="image/*,video/*"
                            class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-orange-50 file:text-orange-700 hover:file:bg-orange-100" />
                    </div>
                    <div id="upload-progress-container" class="mt-4 hidden">
                        <div class="text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">Uploading... <span
                                id="upload-percentage">0%</span></div>
                        <div class="progress-bar">
                            <div id="upload-progress-fill" class="progress-bar-fill" style="width: 0%;"></div>
                        </div>
                    </div>
                    <button type="submit" id="post-button"
                        class="w-full bg-orange-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-orange-600 transition duration-300">
                        Post
                    </button>
                </form>
            </div>

            <div id="posts-container" class="space-y-6">
                <p class="text-center text-gray-500">Loading posts...</p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot, doc, getDoc, deleteDoc, updateDoc, arrayUnion, arrayRemove, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase config and app ID
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = {
            apiKey: "AIzaSyA4H3FWOPHj907fXuxYWonUeGOxUfR14wQ",
            authDomain: "foodie-world-app.firebaseapp.com",
            projectId: "foodie-world-app",
            storageBucket: "foodie-world-app.firebasestorage.app",
            messagingSenderId: "118375791133",
            appId: "1:118375791133:web:3e4b70bba50826c9a364f4",
            measurementId: "G-NMT6XGG6R3"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Cloudinary configuration (REPLACE WITH YOUR OWN)
        // You MUST replace 'your-cloud-name' and 'your-upload-preset' with your actual credentials.
        // The upload will fail until you do this.
        const CLOUDINARY_CLOUD_NAME = 'dctfnhyw5';
        const CLOUDINARY_UPLOAD_PRESET = 'foodie_world_uploads';

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const postsCollection = collection(db, `artifacts/${appId}/public/data/posts`);
        let userId = '';
        let userEmail = '';
        let postIdToDelete = null;

        // DOM elements
        const authInfoEl = document.getElementById('auth-info');
        const postsContainer = document.getElementById('posts-container');
        const newPostForm = document.getElementById('new-post-form');
        const postContentInput = document.getElementById('post-content');
        const mediaInput = document.getElementById('media-input');
        const postButton = document.getElementById('post-button');
        const uploadProgressContainer = document.getElementById('upload-progress-container');
        const uploadProgressFill = document.getElementById('upload-progress-fill');
        const uploadPercentage = document.getElementById('upload-percentage');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmYesBtn = document.getElementById('confirm-yes');
        const confirmNoBtn = document.getElementById('confirm-no');
        const authSection = document.getElementById('auth-section');
        const appContent = document.getElementById('app-content');
        const loginFormContainer = document.getElementById('login-form-container');
        const signupFormContainer = document.getElementById('signup-form-container');
        const showLoginBtn = document.getElementById('show-login');
        const showSignupBtn = document.getElementById('show-signup');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');

        // Helper function for showing messages
        function showMessage(message, isError) {
            const messageBox = document.getElementById('message-box');
            messageBox.textContent = message;
            messageBox.className = `message-box show ${isError ? 'bg-red-500 text-white' : 'bg-green-500 text-white'}`;
            setTimeout(() => {
                messageBox.className = 'message-box';
            }, 3000);
        }

        // Function to set up the real-time listeners for posts and comments
        function setupRealtimeListeners() {
            // Real-time listener for posts
            onSnapshot(postsCollection, (snapshot) => {
                const posts = [];
                snapshot.forEach(doc => {
                    posts.push({ id: doc.id, ...doc.data() });
                });
                // Sort posts by creation time descending
                posts.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
                postsContainer.innerHTML = posts.map(renderPost).join('');
            });

            // Event listener for post actions (like/delete/comments/share)
            postsContainer.addEventListener('click', async (e) => {
                if (!db || !userId) {
                    showMessage('You must be logged in to interact with posts.', true);
                    return;
                }

                const target = e.target.closest('button[data-action]');
                if (!target) return;

                const action = target.dataset.action;
                const postEl = target.closest('[id^="post-"]');
                if (!postEl) return;

                const postId = postEl.id.split('-')[1];
                const postDocRef = doc(db, postsCollection.path, postId);

                try {
                    if (action === 'like') {
                        await runTransaction(db, async (transaction) => {
                            const postDoc = await transaction.get(postDocRef);
                            if (!postDoc.exists()) {
                                throw "Post does not exist!";
                            }
                            const postData = postDoc.data();
                            const likes = postData.likes || [];
                            if (likes.includes(userId)) {
                                // Unlike the post
                                transaction.update(postDocRef, { likes: arrayRemove(userId) });
                            } else {
                                // Like the post
                                transaction.update(postDocRef, { likes: arrayUnion(userId) });
                            }
                        });
                    } else if (action === 'delete') {
                        const postDoc = await getDoc(postDocRef);
                        if (postDoc.exists() && postDoc.data().userId === userId) {
                            // Store the post ID and show the custom modal
                            postIdToDelete = postId;
                            confirmModal.classList.remove('hidden');
                        } else {
                            showMessage('You can only delete your own posts.', true);
                        }
                    } else if (action === 'share') {
                        const postContent = postEl.querySelector('p').textContent;
                        if (navigator.share) {
                            try {
                                // The URL is a placeholder as this is a single-page app
                                await navigator.share({
                                    title: 'Foodie World',
                                    text: postContent,
                                    url: window.location.href,
                                });
                                // showMessage('Post shared successfully!', false);
                            } catch (error) {
                                console.error('Error sharing:', error);
                            }
                        } else {
                            showMessage('Your browser does not support the Web Share API.', true);
                        }
                    } else if (action === 'toggle-comments') {
                        const commentsSection = document.getElementById(`comments-section-${postId}`);
                        commentsSection.classList.toggle('hidden');

                        // If comments are now visible, set up the real-time listener for them
                        if (!commentsSection.classList.contains('hidden')) {
                            onSnapshot(collection(db, `artifacts/${appId}/public/data/posts/${postId}/comments`), (commentsSnapshot) => {
                                const commentsList = document.getElementById(`comments-list-${postId}`);
                                const comments = [];
                                commentsSnapshot.forEach(commentDoc => {
                                    comments.push({ id: commentDoc.id, ...commentDoc.data() });
                                });
                                // Sort comments by creation time
                                comments.sort((a, b) => (a.createdAt?.toMillis() || 0) - (b.createdAt?.toMillis() || 0));
                                commentsList.innerHTML = comments.map(renderComment).join('');

                                // Update the comment count on the post
                                const commentCountEl = document.querySelector(`.comment-count-${postId}`);
                                if (commentCountEl) {
                                    commentCountEl.textContent = comments.length;
                                }
                            });
                        }
                    }
                } catch (error) {
                    console.error(`Error handling action ${action} on post ${postId}:`, error);
                    showMessage(`Failed to update post: ${error.message}`, true);
                }
            });

            // Event listener for comment form submission
            postsContainer.addEventListener('submit', async (e) => {
                const targetForm = e.target.closest('form[data-action="add-comment"]');
                if (!targetForm || !db || !userId) return;

                e.preventDefault();

                const postId = targetForm.dataset.postId;
                const commentInput = targetForm.querySelector('.comment-input');
                const content = commentInput.value.trim();

                if (!content) return;

                try {
                    const commentsCollectionRef = collection(db, `artifacts/${appId}/public/data/posts/${postId}/comments`);
                    await addDoc(commentsCollectionRef, {
                        userId: userId,
                        content: content,
                        createdAt: serverTimestamp()
                    });

                    // Use a transaction to update the comment count on the post
                    await runTransaction(db, async (transaction) => {
                        const postDoc = await transaction.get(doc(postsCollection, postId));
                        const newCommentCount = (postDoc.data().commentCount || 0) + 1;
                        transaction.update(doc(postsCollection, postId), { commentCount: newCommentCount });
                    });

                    commentInput.value = ''; // Clear input after successful post
                    showMessage('Comment added!', false);
                } catch (error) {
                    console.error("Error adding comment:", error);
                    showMessage(`Failed to add comment: ${error.message}`, true);
                }
            });
        }

        // Authentication State Listener
        // This function handles UI changes based on the user's login status.
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in.
                userId = user.uid;
                userEmail = user.email;
                authInfoEl.innerHTML = `
                    <span class="font-semibold">${userEmail}</span>
                    <button id="logout-btn" class="text-sm text-red-500 hover:text-red-700 font-bold ml-4">
                        Log Out
                    </button>
                `;
                authSection.classList.add('hidden');
                appContent.classList.remove('hidden');

                // Add event listener for the new logout button
                document.getElementById('logout-btn').addEventListener('click', async () => {
                    try {
                        await signOut(auth);
                        showMessage('Logged out successfully!', false);
                    } catch (error) {
                        console.error('Logout error:', error);
                        showMessage(`Logout failed: ${error.message}`, true);
                    }
                });

                // Set up the real-time listeners for the authenticated user
                setupRealtimeListeners();

            } else {
                // User is signed out.
                userId = '';
                userEmail = '';
                authInfoEl.textContent = '';
                authSection.classList.remove('hidden');
                appContent.classList.add('hidden');

                // Check for and use the initial custom auth token if available.
                // This allows the app to function immediately in the canvas environment.
                if (initialAuthToken) {
                    try {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log('Signed in with custom token.');
                    } catch (error) {
                        console.error('Custom token sign-in failed:', error);
                        showMessage('Session expired. Please log in or sign up.', true);
                    }
                }
            }
        });

        // Function to handle video/image upload to Cloudinary
        async function uploadMedia(file) {
            // Check if Cloudinary credentials are set
            // if (CLOUDINARY_CLOUD_NAME === 'dctfnhyw5' || CLOUDINARY_UPLOAD_PRESET === 'foodie_world_uploads') {
            //     throw new Error("Cloudinary credentials are not set. Please update the code.");
            // }

            return new Promise((resolve, reject) => {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);

                const xhr = new XMLHttpRequest();
                xhr.open('POST', `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/auto/upload`, true);

                // Handle progress
                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const percent = Math.round((e.loaded / e.total) * 100);
                        uploadProgressFill.style.width = `${percent}%`;
                        uploadPercentage.textContent = `${percent}%`;
                    }
                });

                // Handle load (success)
                xhr.onload = () => {
                    if (xhr.status === 200) {
                        const response = JSON.parse(xhr.responseText);
                        resolve(response.secure_url);
                    } else {
                        reject(new Error('Upload failed.'));
                    }
                };

                // Handle error
                xhr.onerror = () => {
                    reject(new Error('Network error during upload.'));
                };

                xhr.send(formData);
            });
        }

        // Event listener for the new post form submission
        newPostForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!db || !userId) {
                showMessage('You must be logged in to create a post.', true);
                return;
            }

            let mediaUrl = '';
            const file = mediaInput.files[0];
            const content = postContentInput.value.trim();

            if (!content && !file) {
                showMessage('Please enter content or select a file.', true);
                return;
            }

            try {
                // Disable form elements during upload
                postButton.disabled = true;
                mediaInput.disabled = true;
                postContentInput.disabled = true;
                uploadProgressContainer.classList.remove('hidden');

                if (file) {
                    showMessage('Starting upload...', false);
                    mediaUrl = await uploadMedia(file);
                    showMessage('Upload complete!', false);
                }

                // Create the new post in Firestore
                const newPost = {
                    userId,
                    userEmail, // Store the user's email with the post
                    content,
                    mediaUrl,
                    createdAt: serverTimestamp(),
                    likes: [],
                    commentCount: 0
                };

                await addDoc(postsCollection, newPost);
                showMessage('Post created!', false);

                // Clear the form
                newPostForm.reset();
            } catch (error) {
                console.error("Error creating post:", error);
                showMessage(`Failed to create post: ${error.message}`, true);
            } finally {
                // Re-enable form elements
                postButton.disabled = false;
                mediaInput.disabled = false;
                postContentInput.disabled = false;
                uploadProgressContainer.classList.add('hidden');
                uploadProgressFill.style.width = '0%';
                uploadPercentage.textContent = '0%';
            }
        });

        // Function to render a single comment
        function renderComment(comment) {
            return `
                <div class="bg-gray-100 dark:bg-gray-700 p-3 rounded-lg mt-2">
                    <span class="text-xs font-bold text-gray-500 dark:text-gray-300">${comment.userId.substring(0, 8)}...</span>
                    <p class="text-sm">${comment.content}</p>
                </div>
            `;
        }

        // Function to render a single post
        function renderPost(post) {
            const mediaHTML = post.mediaUrl ?
                `<div class="mb-4 rounded-lg overflow-hidden shadow-sm">
                     ${post.mediaUrl.endsWith('.mp4') || post.mediaUrl.endsWith('.webm') ?
                    `<video controls src="${post.mediaUrl}" class="w-full"></video>` :
                    `<img src="${post.mediaUrl}" alt="Post image" class="w-full">`}
                 </div>` : '';

            const isLiked = post.likes.includes(userId);

            // Only show the delete button if the current user is the post creator
            const deleteButton = (post.userId === userId) ?
                `<button data-action="delete" class="text-sm text-red-500 hover:text-red-700 transition duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.035 21H7.965a2 2 0 01-1.996-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                 </button>` : '';

            const heartIcon = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 fill-current" viewBox="0 0 24 24">
                    <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                </svg>
            `;

            const commentIcon = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                </svg>
            `;

            const shareIcon = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.882 13.882 9 14.512 9 15c0 1.657-1.343 3-3 3s-3-1.343-3-3 1.343-3 3-3c.488 0 1.118.118 1.658.316m5.684-1.658C15.118 7.118 15 6.488 15 6c0-1.657 1.343-3 3-3s3 1.343 3 3-1.343 3-3 3c-.488 0-1.118-.118-1.658-.316m-7.684 6.658L9 15h6l-1.658-1.658m2-2.342h-2m-2-2.342v2m0 2v2m-2 2h2" />
                </svg>
            `;

            const postHTML = `
                <div id="post-${post.id}" class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl post-card">
                    <div class="flex items-center justify-between mb-4">
                        <span class="text-sm font-semibold text-gray-500 dark:text-gray-400">
                            Posted by: ${post.userEmail}
                        </span>
                        <div class="flex items-center space-x-2">
                            ${deleteButton}
                        </div>
                    </div>
                    ${mediaHTML}
                    <p class="text-gray-700 dark:text-gray-300 mb-4">${post.content}</p>
                    <div class="flex items-center justify-between border-t border-gray-200 dark:border-gray-700 pt-4">
                        <div class="flex items-center space-x-4">
                            <button data-action="like" data-post-id="${post.id}" class="flex items-center space-x-1 ${isLiked ? 'text-orange-500' : 'text-gray-400'} hover:text-orange-500 transition duration-300">
                                ${heartIcon}
                                <span class="text-sm font-medium">${post.likes.length}</span>
                            </button>
                            <button data-action="toggle-comments" data-post-id="${post.id}" class="flex items-center space-x-1 text-gray-400 hover:text-blue-500 transition duration-300">
                                ${commentIcon}
                                <span class="text-sm font-medium comment-count-${post.id}">${post.commentCount}</span>
                            </button>
                            <button data-action="share" data-post-id="${post.id}" class="flex items-center space-x-1 text-gray-400 hover:text-blue-500 transition duration-300">
                                ${shareIcon}
                                <span class="text-sm font-medium">Share</span>
                            </button>
                        </div>
                        <span class="text-sm text-gray-400">
                            ${post.createdAt ? new Date(post.createdAt.toDate()).toLocaleDateString() : 'Loading...'}
                        </span>
                    </div>

                    <div id="comments-section-${post.id}" class="mt-6 space-y-4 hidden">
                        <div id="comments-list-${post.id}" class="space-y-2">
                            </div>
                        <form data-action="add-comment" data-post-id="${post.id}" class="flex space-x-2 mt-4">
                            <input type="text" placeholder="Add a comment..." required
                                class="comment-input w-full p-2 rounded-lg border dark:border-gray-700 dark:bg-gray-900 text-sm focus:outline-none focus:ring-2 focus:ring-orange-500" />
                            <button type="submit" class="bg-orange-500 text-white p-2 rounded-lg hover:bg-orange-600 transition duration-300 text-sm">
                                Post
                            </button>
                        </form>
                    </div>
                </div>
            `;
            return postHTML;
        }


        // Event listeners for login/signup form switching
        showSignupBtn.addEventListener('click', (e) => {
            e.preventDefault();
            loginFormContainer.classList.add('hidden');
            signupFormContainer.classList.remove('hidden');
        });

        showLoginBtn.addEventListener('click', (e) => {
            e.preventDefault();
            signupFormContainer.classList.add('hidden');
            loginFormContainer.classList.remove('hidden');
        });

        // Event listener for signup form submission
        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = e.target.elements['signup-email'].value;
            const password = e.target.elements['signup-password'].value;
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                showMessage('Account created successfully!', false);
            } catch (error) {
                console.error('Signup error:', error);
                showMessage(`Signup failed: ${error.message}`, true);
            }
        });

        // Event listener for login form submission
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = e.target.elements['login-email'].value;
            const password = e.target.elements['login-password'].value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                showMessage('Logged in successfully!', false);
            } catch (error) {
                console.error('Login error:', error);
                showMessage(`Login failed: ${error.message}`, true);
            }
        });

        // Event listener for modal buttons
        confirmYesBtn.addEventListener('click', async () => {
            if (postIdToDelete) {
                try {
                    await deleteDoc(doc(db, postsCollection.path, postIdToDelete));
                    showMessage('Post deleted successfully.', false);
                } catch (error) {
                    console.error('Error deleting post:', error);
                    showMessage(`Failed to delete post: ${error.message}`, true);
                } finally {
                    confirmModal.classList.add('hidden');
                    postIdToDelete = null;
                }
            }
        });

        confirmNoBtn.addEventListener('click', () => {
            confirmModal.classList.add('hidden');
            postIdToDelete = null;
        });

    </script>
</body>

</html>